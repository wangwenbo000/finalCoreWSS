<%=include adminheader_index.html%>
<h1 class="page-header"><span class="glyphicon glyphicon-gift" aria-hidden="true"></span> 订单管理 <small>Order Manage</small></h1>

<div class="row staticcount page-header">
    <div class="col-lg-3 ">
        <h3>订单列表</h3>
    </div>
    <div class="col-lg-9">
        <h4 class="text-right">
            共<%=count%>单 |
            已发货3单 |
            已成功<%=succ%>单 |
            待付款3单 |
            待发货3单 |
            待退款0单 |
            已退款0单 |
            已取消0单 |
            异常0单
        </h4>
    </div>
</div>

<form id="formfliter">
<div class="row">
    <div class="col-lg-1">
        <select class="form-control" v-model="searchC">
            <option value="*">all</option>
            <option value="id">id</option>
            <option value="phonenum">手机号</option>
            <option value="receiveuser">用户名</option>
            <option value="ordernum">订单号</option>
        </select>
    </div>
    <div class="col-lg-11">
        <div class="input-group">
            <input type="text" class="form-control" aria-label="..." v-model="searchV">
            <div class="input-group-btn">
                <button type="button" class="btn btn-primary fliterBtn" data-loading-text="Loading..." autocomplete="off" >订单筛选</button>
            </div><!-- /btn-group -->
        </div><!-- /input-group -->
    </div><!-- /.col-lg-6 -->
</div><!-- /.row -->
<div class="row orderfliter">
    <div class="col-lg-1">
        <select class="form-control" v-model="productstatic">
            <option value="*">all</option>
            <option value="30">已发送订单</option>
            <option value="40">待收货订单</option>
            <option value="55">已完成订单</option>
            <option value="30">已取消订单</option>
        </select>
    </div>
    <div class="col-lg-1">
        <select class="form-control" v-model="expresstime">
            <option value="*">all</option>
            <option>7:00-7:30</option>
            <option>7:30-8:00</option>
            <option>8:00-8:30</option>
            <option>8:30-9:00</option>
            <option>9:00-9:30</option>
            <option>9:30-10:00</option>
        </select>
    </div>
    <div id="chinaSel">
        <div class="col-lg-1">
            <select class="form-control province" v-model="province" name="province"></select>
        </div>
        <div class="col-lg-1">
            <select class="form-control city" v-model="city" name="city"></select>
        </div>
        <div class="col-lg-2">
            <select class="form-control area" v-model="area" name="area"></select>
        </div>
    </div>
    <div class="col-lg-2">
            <div class="input-group date form_date" data-date="" data-date-format="dd MM yyyy" data-link-field="flitertime" data-link-format="yyyy-mm-dd">
                <input class="form-control" size="16" type="text" value="" readonly>
                <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
            </div>
            <input type="hidden" id="flitertime" value="" /><br/>
    </div>
    <div class="col-lg-2">
        <div class="input-group">
            <span class="input-group-addon">叫起</span>
                <select class="form-control" v-model="iscallmeup">
                    <option value="*">全部</option>
                    <option value="1">是</option>
                    <option value="0">否</option>
                </select>
            </div>
    </div>
    <div class="col-lg-2">
        <button type="button" class="btn btn-primary btn-block">重置条件</button>
    </div>
</div>
    <input type="hidden" id="fliterjson" value="{{$data | json}}" />
</form>
<nav>
    <ul class="pagination">
    <%-pager%>
    <li><span>共<%=count%>笔数据</span></li>
</ul>
</nav>
<div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead>
        <tr>
            <th>id</th>
            <th>图片</th>
            <th>产品名称</th>
            <th>数量</th>
            <th>购买者</th>
            <th>配送地址</th>
            <th>单价</th>
            <th>配送费</th>
            <th><span class="glyphicon glyphicon-bell" aria-hidden="true"></span></th>
            <th>配送时间</th>
            <th>联系电话</th>
            <th>订单号</th>
            <th>下单时间</th>
            <th>操作</th>
            <th>订单状态</th>
        </tr>
        </thead>
        <tbody>
        <tr id="orderlist" v-repeat="order:order" class="item-{{$index}}">
            <td><h5>{{order.id}}</h5></td>
            <td><img src="/resource/img/food/{{order.foodimg}}" width="40" class="img-circle"></td>
            <td>{{order.productname}}</td>
            <td>×{{order.productnum}}</td>
            <td>
                {{order.receiveuser}}
            </td>
            <td>{{order.expressaddress}}</td>
            <td><h5>￥{{order.singleprice}}</h5></td>
            <td><h5>{{order.expressprice}}</h5></td>
            <td>{{order.iscallmeup}}</td>
            <td>{{order.expresstime}}</td>
            <td><h5>{{order.phonenum}}</h5></td>
            <td><h5>{{order.ordernum}}</h5></td>
            <td>{{order.time}}{{order.test}}</td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
                        订单操作 <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="#" data-toggle="modal" data-target=".bs-example-modal-lg"><span class="glyphicon glyphicon-paperclip" area-hidden="true"></span> 依附关系</a></li>
                        <li><a href="#" data-toggle="modal" data-target=".bs-example-modal-lg"><span class="glyphicon glyphicon-eye-open" area-hidden="true"></span> 订单详情</a></li>
                        <li class="divider"></li>
                        <li><a href="#" data-toggle="modal" data-target="#checkmodal"> 取消订单</a></li>
                        <li><a href="#"> 退款</a></li>
                    </ul>
                </div>
            </td>
            <td><span class="label label-success static{{order.productstaticnum}}">{{order.productstatic}}</span></td>
        </tr>
        </tbody>
    </table>
    <nav><ul class="pagination">
        <%-pager%>
        <li><span>共<%=count%>笔数据</span></li>
    </ul>
    </nav>
</div>
<div class="modal fade bs-example-modal-lg" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">订单详情 <small>谨慎操作，该操作会造成用户数据不符。请确定提前与用户进行过沟通</small></h4>
            </div>
            <div class="modal-body">
                <div role="tabpanel">

                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">订单详情</a></li>
                        <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">依附关系</a></li>
                        <li role="presentation"><a href="#editOrder" aria-controls="profile" role="tab" data-toggle="tab">编辑订单</a></li>
                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="home">
                            <br>
                            <table class="table table-bordered">
                                <tbody>
                                <tr>
                                    <td><img src="/resource/img/food/1.jpg" width="60"></td>
                                    <td>早安一号早餐</td>
                                    <td><h4>×3</h4></td>
                                    <td><h2>王文博</h2></td>
                                    <td><h4>ZA050700279</h4></td>
                                    <td class="static30" align="center"><h3>待发货</h3></td>
                                </tr>
                                <tr>
                                    <td>望京</td>
                                    <td>大厦</td>
                                    <td colspan="2">朝阳区启阳路中青大厦B座凤凰网</td>
                                    <td>配送费：￥0</td>
                                    <td><h4>15117909848</h4></td>
                                </tr>
                                <tr>
                                    <td colspan="2">配送时间</td>
                                    <td colspan="2">配送地点</td>
                                    <td colspan="2">是否叫起服务</td>
                                </tr>
                                <tr>
                                    <td colspan="3">配送员</td>
                                    <td>没有参与活动</td>
                                    <td>单价：20</td>
                                    <td><h2 class="text-danger">￥88</h2></td>
                                </tr>
                                <tr>
                                    <td colspan="6">活动相关</td>
                                </tr>
                                <tr>
                                    <td colspan="6">早餐详细描述</td>
                                </tr>
                                </tbody>
                            </table>
                            <h3 class="page-header">订单配送纪录</h3>
                            <dl class="dl-horizontal page-header">
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>商家已经确认早餐准备分配 您的早餐正在爱心制作 ❤️</dd>
                                <div class="divider"></div>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>已经为你分配早餐 配送员<strong> 张师傅 </strong></dd>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>配送员<strong> 张师傅 </strong>已经查看了您的订单准备配送</dd>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>配送员<strong> 张师傅 </strong>已经出发，请保持通信畅通 联系电话：1383838438</dd>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd class="text-danger">配送员没有与您联系上，早餐被退回,请联系配送员或致电：1338888888</dd>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>您已签收订单，祝您一天有个好心情。欢迎反馈您的<a href="javascripy:;" >意见和建议</a></dd>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>您已提交退款申请，退款理由：</dd>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>退款申请已被受理，请耐心等待，我们将尽快为您办理退款</dd>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>商家已确定为您办理退款，款项将在XXX内退回到您的账户请注意查收</dd>
                                <dt>2015-05-10T16:00:00.000Z</dt>
                                <dd>数据库维护，您的订单已过期，无法进行操作</dd>
                            </dl>
                                <button type="button" class="btn btn-danger btn-block btn-lg" data-dismiss="modal" data-toggle="modal" data-target="#checkmodal">取消订单</button>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="profile">
                            <br>
                            <table class="table table-bordered">
                                <tbody>
                                <tr class="success">
                                    <td><img src="/resource/img/food/1.jpg" width="60"></td>
                                    <td colspan="2">早安一号早餐</td>
                                    <td><h2>王文博</h2></td>
                                    <td><img src="/resource/img/adminimg/face1.jpg" width="60" class="img-circle"></td>
                                    <td><h4>ZA050700279</h4></td>
                                </tr>
                                <tr class="bg-success">
                                    <td colspan="2">配送时间</td>
                                    <td colspan="2">配送地点</td>
                                    <td colspan="2">是否叫起服务</td>
                                </tr>
                                <tr class="bg-success">
                                    <td colspan="3">朝阳区启阳路中青大厦B座凤凰网</td>
                                    <td>没有参与活动</td>
                                    <td>单价：20</td>
                                    <td><h2 class="text-danger">￥88</h2></td>
                                </tr>
                                <tr>
                                    <th colspan="6">配餐列表</th>
                                </tr>
                                <tr>
                                    <td><img src="/resource/img/food/1.jpg" width="40" class="img-circle"></td>
                                    <td><h4>ZA050700279</h4></td>
                                    <td><h4>×3</h4></td>
                                    <td>7:00-7:30 叫起</td>
                                    <td><h4 class="text-danger">￥20</h4></td>
                                    <td><span class="label label-success static{{order.productstaticnum}}">状态</span></td>
                                </tr>
                                <tr>
                                    <td><img src="/resource/img/food/1.jpg" width="40" class="img-circle"></td>
                                    <td><h4>ZA050700279</h4></td>
                                    <td><h4>×3</h4></td>
                                    <td>7:00-7:30 叫起</td>
                                    <td><h4 class="text-danger">￥20</h4></td>
                                    <td><span class="label label-success static{{order.productstaticnum}}">状态</span></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="editOrder">暂时不允许修改订单</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<!--确定模态-->
<div class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel" aria-hidden="true" id="checkmodal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <h3>确认取消订单？</h3>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">放弃</button>
                <button type="button" class="btn btn-danger">确定取消</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    var showListJson = <%- JSON.stringify(orderList) %>;
    var orderList = new Vue({
        el:'#orderlist',
        data:{order:showListJson}
    });
    var formfliter = new Vue({
        el: '#formfliter',
        data: {
            searchC:'*',
            productstatic:'*',
            expresstime:'*',
            iscallmeup:'*'
        }
    });
    $('.form_date').datetimepicker({
        language:  'zh-CN',
        weekStart: 1,
        todayBtn:  1,
        autoclose: 1,
        todayHighlight: 1,
        startView: 2,
        minView: 2,
        forceParse: 0
    });
    $('.form_time').datetimepicker({
        language:  'fr',
        weekStart: 1,
        todayBtn:  1,
        autoclose: 1,
        todayHighlight: 1,
        startView: 1,
        minView: 0,
        maxView: 1,
        forceParse: 0
    });
    $(document).ready(function(){
        var fliterJSON = {};

        $('button[class~=fliterBtn]').on('click',function(){
            var $btnstatic = $(this).button('loading');

            var getFliterJson = JSON.parse($('#fliterjson').attr('value'));
            if($('#flitertime').attr('value')!=''){
                getFliterJson.time = $('#flitertime').attr('value');
            }
            if(getFliterJson[getFliterJson.searchC] != '' || getFliterJson[getFliterJson.searchC] != '*'){
                getFliterJson[getFliterJson.searchC] = getFliterJson.searchV;
                delete getFliterJson.searchC;
                delete getFliterJson.searchV;
                delete getFliterJson['*'];
            }
            $.each(getFliterJson,function(index,item){
                if(item=='*') delete getFliterJson[index];
            });
            console.log(getFliterJson);
            Messenger().run({
                successMessage: '数据请求成功.',
                errorMessage: 'Error saving data',
                progressMessage: '正在处理数据',
            },{
                url: '/Admin/Order/fliter',
                type:'post',
                data:{'fliterjson':JSON.stringify(getFliterJson)},
                success:function(data){
                    orderList.$data.order = JSON.parse(data);
                    console.log(JSON.parse(data));
                    $btnstatic.button('reset');
                }
            });

        })

    })
    $.cxSelect.defaults.url = '/resource/js/sendAddress.json';

    $('#chinaSel').cxSelect({
        selects: ['province', 'city', 'area']
    });
</script>
<%=include adminfooter_index.html%>