<%=include indexheader_index.html%>
  <script>
    var addresslistJson = <%- JSON.stringify(addresslist)%>;
    var calendarArr = <%-JSON.stringify(calendarArr)%>;
    // jsapi
    configWxJsapi();
  </script>
  <div id="indexPostOrder" v-cloak>
    <nav class="navbar navbar-default navbar-fixed-bottom ">
      <a href="javascript:;" class="btn paybtn" v-on="click:pay" data-loading-text="订单正在生成">确认订单</a>
      <p class="countP">
        <span>总价:</span>
        <span>{{total | currency '¥'}}</span>
      </p>
    </nav>
    <div class="jumbotron">
      <div class="row">
        <div class="col-xs-12">
          <img src="/resource/img/indexImg/logo.png" id="logo" class="pull-left">
          <img src="<%=WxUserInfo.face %>" id="face" class="pull-right img-circle">
        </div>
      </div>
      <table id="showP" class="table table-bordered calendar">
        <tr>
          <td colspan="7">
            <h3 class="calTitle"><%=date%>月<small>一周早餐</small></h3>
          </td>
        </tr>
        <tr>
          <th v-repeat="calendar">{{week}}</th>
        </tr>
        <tr>
          <td v-repeat="cal in calendar" v-on="click:chooseDay(cal)" v-class="success:cal.done">
            <h4><u>{{{cal.days | repertoryIsEmpty}}}</u></h4>
          </td>
        </tr>
      </table>
      <table class="table table-condensed">
        <tr v-repeat="cal in calendar" v-show="cal.done">
          <td>
            <img v-attr="src:'/resource/img/food/'+cal.productInfo.days+'.jpg'" width="40">
          </td>
          <td>
            <h5>{{cal.productInfo.productName}}<small> ×{{everyDayNum}}</small></h5>
            <span class="text-muted">{{cal.date}}</span>
          </td>
          <td class="text-danger">{{cal.productInfo.price | currency '¥'}}</td>
          <td>
            <span class="label label-warning">周{{cal.week}}</span>
          </td>
        </tr>
      </table>
      <div class="alert alert-warning" role="alert">
        <button type="button" class="close" data-dismiss="alert">
          <span>&times;</span>
        </button>
        每天<span class="label label-warning">22:00</span> 前可预订明日早餐 🌞
      </div>
    </div>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12">
          <div class="input-group">
            <div class="input-group-btn">
              <button type="button" class="btn btn-success" v-on="click:foodNumPriceCount(everyDayNum--)">—</button>
            </div>
            <span class="input-group-addon">每天</span>
            <input type="text" class="form-control" v-model="everyDayNum | numNotZreo">
            <span class="input-group-addon">份</span>

            <div class="input-group-btn">
              <button type="button" class="btn btn-success" v-on="click:foodNumPriceCount(everyDayNum++)">+</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-6">
          <select class="form-control" v-model="expressTime">
            <option value="0">配送时间段</option>
            <option>7:00-7:30</option>
            <option>7:30-8:00</option>
            <option>8:00-8:30</option>
            <option>8:30-9:00</option>
            <option>9:00-9:30</option>
            <option>9:30-10:00</option>
          </select>
        </div>
        <div class="col-xs-6">
          <select class="form-control" v-model="receiveWay">
            <option value="0">接收方式</option>
            <option>早安盒子</option>
            <option>公司前台</option>
            <option>延迟配送</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12">
          <button type="submit" class="btn btn-default btn-block btn-lg" data-toggle="modal" data-target="#chooseAddress"><i class="glyphicon glyphicon-plus-sign"></i> 选择配送地址
          </button>
        </div>
      </div>
    </div>
    <div class="modal fade" id="chooseAddress" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><i class="glyphicon glyphicon-remove-circle"></i></button>
            <h4 class="modal-title">选择一个收货地址</h4>
          </div>
          <div class="modal-body address-body">
            <table class="table">
              <tr v-repeat="al in addresslist" data-index={{$index}} v-on="click:chooseAddress(al)">
                <td>
                  <h4>{{al.receiveuser}}<small> {{al.phonenum}}</small></h4>{{al.address}}
                </td>
                <td v-on="click:editAddress(this)">
                  <a href="#" data-toggle="modal" data-target="#addressForm">
                    <h4><i class="glyphicon glyphicon-pencil"></i></h4>
                  </a>
                </td>
              </tr>
            </table>
          </div>
          <div class="modal-footer">
            <!-- addNewaddress FN -->
            <a href="Home/address?back=Home" class="btn btn-success btn-block btn-lg">添加新的订餐地址</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    var sendOrder = new Vue({
      el: '#indexPostOrder',
      data: {
        expressTime: 0,
        receiveWay: 0,
        everyDayNum: 1,
        addresslist: addresslistJson,
        addressCookie:{
          
        }
        calendar: calendarArr,
        total: 0,
        chooseaddressinfo:[]
      },
      computed:{
        totalCount:function(){
          this.total = 0;
          var chooseProductJson = this.calendar;
          for (var k in chooseProductJson) {
            switch (chooseProductJson[k]['done']) {
              case true:
                this.total += chooseProductJson[k]['productInfo']['price'];
                break;
            }
          }
          if(this.everyDayNum<=0) this.everyDayNum = 1;
          this.total *= this.everyDayNum;
          return this.total;
        }
      },
      filters: {
        repertoryIsEmpty: function(value) {
          if (value == "罄") {
            return "<img src=resource/img/indexImg/foodempty.svg width='20'>"
          }else{
            return value;
          }
        },
        numNotZreo: function(val) {
          return val<2?this.everyDayNum = 1:val;
        }
      },
      methods: {
        foodNumPriceCount: function(num){
          this.totalCount;
        },
        chooseAddress: function(thisAddress) {
          this.chooseaddressinfo = thisAddress;
          $('#chooseAddress').modal('hide');
        },
        chooseDay: function(cal) {
          if (cal.productInfo.repertory <= 0) {
            return false;
          } else {
            cal.done = !cal.done;
            this.totalCount;
          }
        },
        pay: function() {
          var paybtn = $('.paybtn').button('loading');
          var chooseProductJson_res = [];
          var chooseProductJson = this.calendar;
          for (var k in chooseProductJson) {
            switch (chooseProductJson[k]['done']) {
              case true:
                chooseProductJson_res.push({
                  productName: chooseProductJson[k].productInfo['productName'],
                  time: chooseProductJson[k]['date'],
                  singleprice: chooseProductJson[k].productInfo['price']
                });
                break;
            }
          }
          if (!chooseProductJson_res.length) {
            showFormErr('没有选择早餐 ☀️');
            paybtn.button('reset');
            return false;
          }
          if (!this.expressTime) {
            showFormErr('还没有选择配送时间');
            paybtn.button('reset');
            return false;
          }
          if (!this.receiveWay) {
            showFormErr('请选择接收方式');
            paybtn.button('reset');
            return false;
          }
          if (!this.chooseaddressinfo) {
            showFormErr('请选择配送地址');
            paybtn.button('reset');
            return false;
          }
          if (this.everyDayNum < 1) {
            showFormErr('每天至少一份早餐');
            paybtn.button('reset');
            return false;
          }
          $.ajax({
            url: 'Home/Index/pay',
            type: 'POST',
            data: {
              userid: '<%- WxUserInfo.id%>',
              productnum: this.everyDayNum,
              receiveWay: this.receiveWay,
              chooselist: JSON.stringify(chooseProductJson_res),
              addressinfo: JSON.stringify(this.chooseaddressinfo),
              expresstime: this.expressTime
            },
            success: function(data) {
              data.errno || unifiedorderFn(data.data);
              }
          });
        }
      }
    });
    // 统一下单接口
    function unifiedorderFn(orderRequest) {
      $.ajax({
          url: 'Admin/wx/unifiedorder',
          type: 'POST',
          data: {
            url: window.location.href,
            out_trade_no: orderRequest.ordernum,
            total_fee: orderRequest.productprice,
            attach:orderRequest.orderid
          },
          success: function(data) {
            var callWxPayJson = data.data;
              wx.chooseWXPay({
                timestamp: callWxPayJson.timeStamp,
                nonceStr: callWxPayJson.nonceStr,
                package: callWxPayJson.package,
                signType: 'MD5',
                paySign: callWxPayJson.paySign,
                success:function(res) {
                  window.location.href = "Home/paysuccess";
                },
                cancel: function (res) {
                  window.location.href = "Home/payfail";
                }
              });
            }
          });
      }
  </script>
  </body>

  </html>
